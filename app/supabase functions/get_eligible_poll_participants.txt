
DECLARE
    poll_record RECORD;
    exclusion_start_date TIMESTAMP;
BEGIN
    -- Get poll details
    SELECT * INTO poll_record 
    FROM polls 
    WHERE id = p_poll_id;
    
    IF NOT FOUND THEN
        RETURN;
    END IF;
    
    -- Calculate exclusion date if recent winners rule is active
    IF poll_record.exclude_recent_winners AND poll_record.exclude_timeframe IS NOT NULL THEN
        CASE poll_record.exclude_timeframe
            WHEN 'day' THEN exclusion_start_date := NOW() - INTERVAL '1 day';
            WHEN 'week' THEN exclusion_start_date := NOW() - INTERVAL '1 week';
            WHEN 'month' THEN exclusion_start_date := NOW() - INTERVAL '1 month';
            ELSE exclusion_start_date := NOW() - INTERVAL '1 week';
        END CASE;
    END IF;
    
    -- Return eligible users
    RETURN QUERY
    SELECT u.id, u.name
    FROM users u
    WHERE 
        -- User is not specifically excluded
        (poll_record.excluded_user_ids IS NULL OR u.id::TEXT != ALL(poll_record.excluded_user_ids))
        
        -- User hasn't already entered this poll
        AND NOT EXISTS (
            SELECT 1 FROM poll_entries pe 
            WHERE pe.poll_id = p_poll_id AND pe.user_id = u.id
        )
        
        -- User is not a recent winner (if rule is active)
        AND (
            NOT poll_record.exclude_recent_winners 
            OR NOT EXISTS (
                SELECT 1 
                FROM poll_results pr
                JOIN polls p ON pr.poll_id = p.id
                WHERE pr.user_id = u.id 
                AND p.created_at >= exclusion_start_date
                AND p.manager_id = poll_record.manager_id
            )
        );
END;
